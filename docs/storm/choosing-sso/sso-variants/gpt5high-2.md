Я соберу структурированный план и сразу зафиксирую его как список задач, чтобы мы могли пошагово исполнять дорожную карту без потери фокуса.

[1 tool called]

### Цель
Построить SSO и IAM “как сервис” для администраторов сайтов на базе Logto OSS + PostgreSQL, с жёстким разделением PII/активности, соблюдением GDPR и опциональной региональной изоляцией данных.

Важно: в вашей формулировке “деанонимизирован” на стороне CMS — на самом деле речь об “анонимизации/псевдонимизации”. На стороне CMS хранится только псевдонимный идентификатор и активность; PII остаётся в SSO/PII-хранилище под шифрованием.

### Высокоуровневая архитектура
- SSO/IAM: Logto OSS (OIDC/OAuth2, MFA, подключаемые провайдеры, админ-API).
- PII-хранилище: PostgreSQL с полевым шифрованием (envelope encryption), ключи в KMS/Vault.
- Consent Service: сбор “opt-in”, селективная выдача claims (минимизация).
- Profile API (UserInfo proxy): отдает только разрешённые атрибуты и только по живому согласию/скоупам.
- Admin Portal: мультиарендный ЛК для настройки клиентов, ролей, политик, конструктор embed-виджета.
- CMS-интеграции: SDK/плагины (Node/Next и PHP для начала).
- Аудит/логирование: WORM-лог, SIEM-потоки, анти-фрод, rate limiting.
- Региональность: кластеры PostgreSQL по регионам (EU/US/...), маршрутизация данных пользователя в “его” регион.

### Поток данных (пример интернет-магазин)
1) Пользователь регистрируется/логинится через виджет SSO → Logto выдает ID Token/Access Token.  
2) PII пишется в PII-хранилище (регионально), CMS получает только pairwise `sub` и набор разрешённых claims.  
3) В CMS хранится активность + `pseudonymous_user_id`. PII туда не попадает (или хранится “нечитаемым” opaque-blob без ключа).  
4) Пользователь управляет согласием в Preference Center (opt-in на конкретные категории/claims).  
5) Админ в ЛК может блокировать пользователя, отзывать токены, просматривать аудит и настраивать политики.

### Ключевые принципы приватности и безопасности
- Pairwise subject (OIDC): разные `sub` на разных сайтах одного/разных админов — исключает кросс-сайт корреляцию без центральной системы.
- Минимизация данных: по умолчанию CMS видит только `sub` и обязательные технические claims; всё остальное — только по согласию.
- Шифрование:
  - At rest: дисковое + Postgres; критично — полевое шифрование PII на уровне приложения (AES-GCM через KMS-обёртку).
  - Индексируемые поля (email, телефон): HMAC-SHA256 для поиска + отдельные детерминированные токены, открытого текста нет.
- Токены: короткоживущие Access Tokens, ротация Refresh Token, немедленная отзывка (RT blacklist).
- DSR: экспорт, удаление, исправление, ограничение обработки, переносимость — с журналом выполнения и SLA.
- Аудит и соответствие: DPIA, RoPA, DPA, SCC (если экстерриториальные трансферы), хранение consent-логов, ретеншн-политики.

### Разделение PII и активности
- Центральное PII-хранилище (на аренду/регион): `users`, `user_pii_encrypted`, `consents`, `pii_access_audit`.
- Для каждого сайта/CMS — отдельная БД или схема с активностью: `events`, `orders_meta`, `sessions`, только `pseudonymous_user_id`.
- Опционально: “нечитаемая” копия отдельных атрибутов в CMS (opaque-blob) — без ключей у CMS это не считается доступной PII.

### ЛК Админа (MVP функционал)
- Тенанты, клиенты (OIDC), редиректы, секреты, политики скоупов.
- Роли/политики доступа (RBAC/ABAC) для менеджеров админа.
- Настройка провайдеров входа (email/телефон/социальные).
- Конструктор виджета: генерирует embed-код, PKCE, нужные скоупы.
- Справочник пользователей: поиск, блокировка, аудит операций.
- Preference Center шаблоны и тексты согласий per клиент/сайт.

### Конструктор авторизаций и цифровой “паспорт”
- Виджет (скрипт) + кнопки входа. Конфигурируется из ЛК.  
- “Паспорт” = ID Token + минимальные claims; расширение через UserInfo proxy строго по согласию.  
- Для CMS — SDK: middlewares для проверки подписи, обработки ротации ключей (JWKS), работы с UserInfo proxy и кэшированием.

### Региональность (data residency)
- На уровне аренды указывается регион хранения PII (и набор разрешённых регионов обработки).  
- Роутинг запросов — в “родной” кластер Postgres; кросс‑регионное чтение запрещено/ограничено политиками.  
- Ключи шифрования — региональные (KMS в том же регионе).

### Технологии и стек
- Logto OSS (Docker, HA behind reverse proxy), PostgreSQL 15/16.  
- KMS: HashiCorp Vault или облачный KMS (AWS/GCP/Azure).  
- Admin Portal: Next.js + TypeScript; Backend: NestJS/Express.  
- Supabase: как управляемый PostgreSQL + RLS для активности/мультиарендности (по желанию).  
- Observability: OpenTelemetry, Prometheus/Grafana, SIEM/ELK.

### Этапы и критерии (оценка 10–14 недель)
- Этап 0 (1–2 нед): DPIA, модели данных/потоков, роли (Controller/Processor), RoPA, DPA/SCC черновики.  
  Критерий: утверждённые диаграммы потоков, lawful basis, реестр активностей.
- Этап 1 (1 нед): Инфра: регионы, KMS/Vault, базовый CI/CD, секреты.  
  Критерий: рабочие стенды EU/US, KMS, стандарты секретов/логов.
- Этап 2 (2 нед): Logto HA + внеш. Postgres, MFA, social/email/phone, pairwise subject.  
  Критерий: успешный OIDC flow с pairwise `sub`, MFA включена.
- Этап 3 (2 нед): PII-схема + envelope encryption + индексы (HMAC).  
  Критерий: запись/чтение PII через сервис, индексация без утечки.
- Этап 4 (2 нед): Admin Portal MVP + конструктор виджета, политики скоупов, Consent Center.  
  Критерий: админ генерирует клиент/скоупы/виджет, пользователь даёт согласия.
- Этап 5 (2 нед): SDK/плагины для CMS (Node/Next, PHP), Profile API (selective disclosure).  
  Критерий: интеграция демо-магазина без PII в БД, только `sub` и активность.
- Этап 6 (1 нед): DSR, аудит, ретеншн, rate limiting, анти‑фрод, мониторинг.  
  Критерий: DSR E2E (export/delete), тревоги и дашборды.
- Этап 7 (1 нед): Пилот, пентест, чек-лист запуска, обучение.  
  Критерий: пилот в проде, план on-call/инцидентов, отчёт пентеста.

### Открытые решения и корректировки
- Идентификатор пользователя для CMS: OIDC pairwise `sub` — это “цифровой паспорт”.  
- В CMS по умолчанию не хранить PII. Если требуется “на всякий случай” — только opaque-blob без ключа.  
- Для поиска по email/телефону в PII — использовать HMAC-индексы и выводить результат только через Profile API.  
- Согласие — по claim-группам (email_basic, identity_basic, address_basic), с TTL и возможностью отзывки.  
- Обработка мульти‑сайта у одного админа: единый sector_identifier_uri для группы доменов — при необходимости один и тот же `sub` (или отдельные — если нужно разделять).

### Риски и как их снижать
- Сложность мульти‑региональности: начать с 1 региона + абстракция роутинга.  
- Утечки через журналы/трейсинг: опция PII‑redaction в логах, секрет‑сканеры в CI.  
- Ошибки согласий: централизованный Consent Service с неизменяемым журналом и регресс‑тестами политик.  
- Производительность: кэш UserInfo proxy, короткие токены, лимиты, нагрузочное тестирование.

### Что сделаем прямо сейчас (DPIA — старт)
- Сформируем перечень обрабатываемых категорий PII и целей обработки.  
- Зафиксируем роли: вы — Controller для ваших пользователей; наша платформа — Processor.  
- Оценим правовые основания (consent/contract/legitimate interest) и географию данных (регионы).  
- Нарисуем DFD (data flow diagram) для SSO→PII→CMS и согласуем.

Если ок — начну оформлять артефакты DPIA (таблицы RoPA, DFD, lawful basis) и переходить к выбору регионов/KMS.

— — —

- Следующие уточнения от вас (коротко):
  - Целевые регионы хранения (например, EU, US, KZ, RU?).  
  - Предпочтительный облако/провайдер (AWS/GCP/Azure/свой DC).  
  - Приоритетные CMS/стек для первых SDK (Next.js/Node и PHP ок?).  
  - Требуется ли один и тот же `sub` на всех сайтах одного админа или строго pairwise?  

Короткий ответ на ключевой тезис: да, архитектура с “цифровым паспортом” (pairwise `sub` + минимальные claims) и хранением PII в отдельном зашифрованном слое даёт GDPR‑совместимую модель, снимает риски утечек на стороне CMS и поддерживает опциональную синхронизацию строго по согласию.

- Завершил постановку задачи “Уточнить GDPR/PII рамки, роли и выполнить DPIA” и перевёл её в работу. Далее займусь “Выбрать регионы, облако, KMS/Vault и логирование-аудит” сразу после ваших ответов на уточнения.

- Внесён список задач в работу (см. ЛК задач).