> gpt-5-high

## Дорожная карта: OSS/airgapped WorkOS‑лайт на ZITADEL + Supabase + UI8Kit/Core

### Северная звезда
- Полностью открытый и автономный стек, который можно развернуть изолированно в любой стране/регионе (включая агломерации и airgapped‑сети).
- Никаких внешних облачных зависимостей во время рантайма: без внешних SDK, облачной телеметрии, публичных CDN и вендорских API.
- Единый SSO (ZITADEL self‑host) + учёт пользователей и приложений, конструктор виджетов входа/регистрации, выбор провайдеров входа.
- Масштабируемая архитектура: можно использовать как облачный сервис, как API+SDK, так и как набор микросервисов.

### Ключевые допущения и ограничения (обновлено)
- Развёртывание по умолчанию — self‑host ZITADEL (Helm/Docker Compose). Доп. профиль для полностью оффлайн‑сред: только локальные пользователи, без социальных провайдеров.
- Supabase (Postgres) используется как хранилище метаданных (тенанты, приложения, провайдеры, вебхуки, аудит). Доступ к кластеру ограничен внутри VPC/сегмента.
- Конструктор виджетов не использует внешние CDN/шрифты/скрипты — все ассеты поставляются локально.
- Телеметрия — упрощённая, на базе SigNoz (через OpenTelemetry). Основная визуализация метрик/состояния — внутри админ‑портала на UI8Kit/Core. Веб‑интерфейс SigNoz может быть отключён/закрыт.
- Сетевые политики: egress по умолчанию deny. Для режима с соц‑логинами формируется точный allowlist доменов OAuth‑провайдеров. Есть профиль «полный оффлайн».
- Без внешних calls для лицензирования, обновлений и т.п. Обновления выполняются через оффлайн‑бандлы образов/чартов.

### Архитектура (высокоуровнево)
- IdP: ZITADEL (self‑host), управление проектами/приложениями через Management API (gRPC/REST).
- Метаданные: Supabase Postgres — `tenants`, `apps`, `providers`, `webhooks`, `audit_events`, `settings`.
- Микросервисы (Go):
  - API Gateway — аутентификация админ‑UI, маршрутизация.
  - Tenants/Apps/Providers Service — CRUD для тенантов/приложений/провайдеров (Supabase).
  - ZITADEL Adapter — создание/настройка org/project/app, связи с провайдерами.
  - Widget Builder/Assets — генерация виджета, темы, локальная доставка ассетов.
  - Webhooks Service — события (login, user lifecycle), подпись, ретраи, dead‑letter.
  - Audit Service — журнал действий админов и системных событий.
- Телеметрия (self‑host):
  - OpenTelemetry SDK/Collector → SigNoz (traces/metrics/logs). Экспорт наружу отключён.
  - Дашборды состояния и метрик в админ‑портале на UI8Kit/Core (агрегация данных из SigNoz и собственных счётчиков).

### Scope MVP (подтверждён)
- Управление тенантами, приложениями (OIDC), redirect URI и секретами.
- Unified SSO через ZITADEL (Auth Code + PKCE). Локальные пользователи по умолчанию, соц‑провайдеры — опционально.
- Конструктор виджетов: login/register сниппет, темы, i18n, zero‑external deps.
- Провайдеры: мастера подключения Google/GitHub/Microsoft (при необходимости), валидация redirect URI, генерация egress‑allowlist.
- SDK/Quickstarts: Node/Next.js и Go (верификация JWT/JWKS с локальным кэшем).
- Вебхуки: вход/выход/создание/обновление пользователя, подпись, ретраи.
- Телеметрия: сбор с сервисов в SigNoz, статус‑виджеты в админ‑портале.
- Пакетирование: offline‑бандл образов, Docker Compose, Helm; SHA‑манифесты.

### Не входит в MVP
- Облачная телеметрия/внешние CDN/вендорские API.
- Расширенные GDPR‑фичи, field‑level шифрование PII и пр.

### Дорожная карта (итерации)
- Нед. 1 — Self‑host база (без внешних зависимостей)
  - Поднять ZITADEL (self‑host) и Supabase локально.
  - Сервисы: Gateway, Tenants/Providers, ZITADEL Adapter (создание org/project/app).
  - Админ‑UI: онбординг тенанта, регистрация приложения, управление redirect URI.
  - Результат: e2e авторизация на демо, все ассеты локально.

- Нед. 2 — Виджеты и провайдеры
  - Widget Builder: темы, i18n, сниппет, zero‑external deps.
  - Провайдеры: мастера (Google/GitHub/MS), проверка конфигов, генерация egress‑allowlist.
  - Demo storefront с виджетом.
  - Результат: подключение провайдера < 10 минут, вход через виджет.

- Нед. 3 — SDK/Webhooks/Telemetry (SigNoz + UI8Kit/Core)
  - SDKs (Node/Next.js, Go): локальный JWKS‑кэш и стабильная проверка токенов.
  - Webhooks: подпись, ретраи, dead‑letter.
  - SigNoz развёрнут локально; сбор OTel с сервисов. В админ‑портале — дашборды состояния (UI8Kit/Core).
  - Результат: наблюдаемость без внешних сервисов, вебхуки устойчивы.

- Нед. 4 — Airgapped packaging и Proxy‑ready
  - Offline bundle образов (локальный реестр), Helm/Compose, SHA‑манифесты.
  - Профили сети: default‑deny egress, allowlist генератор, полный оффлайн режим.
  - Тест‑матрица совместимости с прокси; чек‑листы для эксплуатации.
  - Результат: установка в изолированной сети < 30 минут; тесты прокси проходят.

### Совместимость с прокси (анализ и меры)
- Переменные окружения прокси: `HTTP_PROXY`, `HTTPS_PROXY`, `NO_PROXY` поддерживаются во всех сервисах и SDK; документирован порядок приоритета.
- TLS и доверенные корни: поддержка кастомного CA bundle/trust store; pinning JWKS‑хостов при необходимости.
- JWKS и токены: кэширование JWKS с backoff; валидация токенов оффлайн до TTL; предсказуемые точки JWKS.
- gRPC/HTTP2: проксирование через CONNECT; fallback на gRPC‑Web/HTTP/1.1 при ограничениях.
- WebSocket/SSE: если блокируются, предусмотрен long‑poll fallback.
- DNS/время: конфигурируемый резолвер; контроль clock‑skew для JWT.
- CORS/Headers/Cookies: корректные `sameSite`/`secure` при TLS‑терминации на прокси; стабильные хосты/пути/порты.
- Буферизация/таймауты: параметры для больших ответов и длительных запросов; ретраи безопасных операций идемпотентны.
- Egress policy: профили default‑deny + генерация allowlist по подключённым провайдерам; «полный оффлайн» профиль без внешних вызовов.
- Тест‑матрица: Squid/Nginx сценарии — без аутентификации, Basic, TLS MITM (кастомный CA), блокировки WS/SSE, gRPC fallback; документированы ожидаемые результаты.

### Acceptance‑критерии MVP
- Онбординг: от установки до рабочего SSO с демо‑витриной — < 30 минут, без доступа в Интернет.
- Виджет вставляется одним сниппетом, темы применяются локально, без CDN.
- Минимум 3 провайдера доступны (при наличии egress), оффлайн‑профиль работает без провайдеров.
- SDK/Quickstarts запускаются одной командой, проверки JWT устойчивы к временному отсутствию сети.
- Телеметрия собирается в SigNoz; ключевые дашборды доступны в админ‑портале.

### Примечания
- Вариант с облачными провайдерами входа включается только при явном включении профиля egress‑allowlist.
- Обновления публикуются в виде оффлайн‑бандлов (образы + чарты + контрольные суммы). Внешние проверки версий не используются.


